image:
  name: ubuntu:focal
  entrypoint: ['bash', '-c', 'apt update && apt install -y sudo && useradd madlinux && usermod -a -G sudo madlinux && echo "madlinux ALL=(ALL) NOPASSWD:ALL"|tee /etc/sudoers.d/madlinux && exec su madlinux -c bash']

#variables:
#  ENV: value

before_script:
  - sudo ls -la /var/lib/apt/lists/
  - sudo dpkg --add-architecture i386
  - sudo apt update
  - sudo apt install -y gpg
  - sudo apt install -y software-properties-common
#  - sudo install assets/add-apt-repository /usr/bin/
  - sudo add-apt-repository -y ppa:apt-fast/stable
#  - echo 'deb http://ppa.launchpad.net/apt-fast/stable/ubuntu focal main'|sudo tee /etc/apt/sources.list.d/apt-fast.list
#  - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys A2166B8DE8BDC3367D1901C11EE2FF37CA8DA16B
#  - sudo apt update
  - sudo apt install -y apt-fast
  - sudo sed -i 's/_APTMGR=apt-get/_APTMGR=apt/g' /etc/apt-fast.conf
  - |
    apt-fast install -y \
      build-essential \
      checkinstall \
      devscripts \
      dpkg-sig \
      git \
      liblz4-tool \
      reprepro \
      sshpass \
      sudo \
      wget
  - sudo mkdir -pv /home/madlinux
  - sudo chmod -R 777 /home/madlinux
  - apt-fast install -y debconf-utils
  - sudo debconf-set-selections<assets/selections.conf
  - apt-fast install -y keyboard-configuration
  - aria2c $GPG_SEC
  - gpg --batch --allow-secret-key-import --import madlinux_sec.gpg
  - |
    wget -qO- https://sourceforge.net/projects/madlinux/files/repo/dists/core/main/binary-amd64/Packages|grep \
      'Package:\|Version:'|sed ':a;N;$!ba;s/\nVersion://g'|sed 's/Package: //g'>packages-amd64-1.log
    wget -qO- https://sourceforge.net/projects/madlinux/files/repo/dists/core/main/binary-i386/Packages|grep \
      'Package:\|Version:'|sed ':a;N;$!ba;s/\nVersion://g'|sed 's/Package: //g'>packages-i386-1.log

madrepo:
  script:
  - bash build.sh
  - |
    sshpass -p $SOURCEFORGE_PASS -- \
    rsync -avP --del -e 'ssh -o StrictHostKeyChecking=no' \
    repo rauldipeas@frs.sourceforge.net:/home/frs/project/madlinux
  - |
    wget -qO- https://sourceforge.net/projects/madlinux/files/repo/dists/core/main/binary-amd64/Packages|grep \
      'Package:\|Version:'|sed ':a;N;$!ba;s/\nVersion://g'|sed 's/Package: //g'>packages-amd64-2.log
    wget -qO- https://sourceforge.net/projects/madlinux/files/repo/dists/core/main/binary-i386/Packages|grep \
      'Package:\|Version:'|sed ':a;N;$!ba;s/\nVersion://g'|sed 's/Package: //g'>packages-i386-2.log
  artifacts:
    paths:
    - repo
  only:
  - main